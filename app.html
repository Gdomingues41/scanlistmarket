<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanlist Market</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0 16px; background-color: #fff; }
    .header { background-color: #d40000; padding: 20px; text-align: center; color: white; position: relative; }
    .header img { width: 80px; display: block; margin: 0 auto 10px; }
    .cart-icon { position: absolute; top: 20px; right: 20px; font-size: 24px; color: white; cursor: pointer; }
    .cart-count { background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; position: absolute; top: -10px; right: -10px; }
    .container { max-width: 500px; margin: 0 auto; text-align: center; padding-bottom: 20px; }
    .btn { display: block; width: 100%; background-color: #d40000; color: white; padding: 12px; margin: 8px 0; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    .btn-green { background-color: #28a745; }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { background-color: #ccc; }
    .input-field { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    .product-img { max-width: 200px; margin: 20px auto; display: block; }
    .total-bar { background-color: #d40000; color: white; padding: 10px; text-align: center; font-weight: bold; margin-top: 20px; }
    .big-font * { font-size: 20px !important; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding: 8px 0; }
    .cart-item button { background: none; border: none; color: red; font-size: 20px; cursor: pointer; }
    .quantity-selector button { background: none; border: none; color: red; font-size: 24px; font-weight: bold; cursor: pointer; width: 40px; }
    .quantity-selector span { font-size: 20px; font-weight: bold; margin: 0 15px; }
    .historico-item { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px; text-align: left; }
    .historico-item strong { color: #d40000; }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://i.imgur.com/dHOSups.png" alt="Scanlist Market Logo">
    <h1 id="titulo">Scanlist Market</h1>
    <div class="cart-icon" onclick="verCarrinho()">
      üõí<span class="cart-count" id="cartCount">0</span>
    </div>
  </div>
  <div class="container">
    <div id="reader" style="width: 100%; margin-bottom: 10px;"></div>
    <input id="codigoBarra" class="input-field" placeholder="Digite ou escaneie o c√≥digo">
    <button class="btn" onclick="buscarProduto()">üîç Buscar Produto</button>
    <button class="btn" onclick="escanearProduto()">üì∑ Escanear Produto</button>
    <button class="btn" onclick="cadastrarProdutoManual()">üìù Cadastrar Produto Manualmente</button>
    <button class="btn" onclick="verHistorico()">üìÑ Ver Hist√≥rico</button>
    <button class="btn" onclick="mudarIdioma()">üåê Mudar Idioma PT/EN</button>
    <button class="btn" onclick="toggleAcessibilidade()">üßì Acessibilidade</button>
    <div id="produto-info" style="display:none; text-align: center;">
      <img id="produto-imagem" class="product-img" src="" alt="Imagem do Produto">
      <input id="produto-nome" type="text" class="input-field" placeholder="Nome do produto" />
      <input id="preco-unitario" type="number" class="input-field" placeholder="Pre√ßo unit√°rio">
      <p style="margin-top:15px; margin-bottom: 5px; font-weight: bold;">Quantidade:</p>
      <div class="quantity-selector" style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
          <button type="button" onclick="alterarQuantidade(-1)">-</button>
          <span id="quantidade-display">1</span>
          <button type="button" onclick="alterarQuantidade(1)">+</button>
      </div>
      <input type="hidden" id="quantidade" value="1"> 
      <button class="btn" onclick="adicionarAoCarrinho()">‚ûï Adicionar ao Carrinho</button>
    </div>
    <div id="carrinhoDetalhado" style="display:none; margin-top: 20px;"></div>
    <div id="historicoContainer" style="margin-top: 20px;"></div>
    <div class="total-bar" id="totalBar" style="display: none;"></div>
    <button id="finalizarBtn" class="btn btn-green" style="display: none;" onclick="finalizarCompra()">üõí Finalizar Compra</button>
    <p style="margin-top: 24px; font-size: 14px;">Apoie o projeto üíñ<br>Pix: <strong>biedomingues33@gmail.com</strong></p>
    <div style="margin-top: 10px;">
      <form action="https://www.paypal.com/donate" method="post" target="_blank">
        <input type="hidden" name="business" value="biedomingues33@gmail.com">
        <input type="hidden" name="currency_code" value="USD">
        <input type="hidden" name="amount" value="4.99">
        <input type="submit" value="Doar via PayPal (US$4.99)" class="btn">
      </form>
    </div>
  </div>

  <script type="module">
    // Importando TODAS as ferramentas necess√°rias
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // ATEN√á√ÉO: COLOQUE SUA CHAVE DE API E DADOS DO FIREBASE AQUI
    const firebaseConfig = {
      apiKey: "SUA_API_KEY_AQUI",
      authDomain: "scanlistmarket-30143.firebaseapp.com",
      projectId: "scanlistmarket-30143",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- SCRIPT PRINCIPAL ---
    let cart = [];
    const dicionario = { /* seu dicion√°rio de idiomas aqui */ };

    // --- FUN√á√ïES DO APP (agora todas p√∫blicas e completas) ---
    
    window.alterarQuantidade = function(delta) {
        const quantidadeInput = document.getElementById("quantidade");
        const quantidadeDisplay = document.getElementById("quantidade-display");
        let novaQuantidade = parseInt(quantidadeInput.value) + delta;
        if (novaQuantidade < 1) novaQuantidade = 1;
        quantidadeInput.value = novaQuantidade;
        quantidadeDisplay.innerText = novaQuantidade;
    };

    function limparCarrinhoUI() {
        cart = [];
        document.getElementById("cartCount").innerText = '0';
        document.getElementById("totalBar").style.display = 'none';
        document.getElementById("carrinhoDetalhado").innerHTML = '';
        document.getElementById("carrinhoDetalhado").style.display = 'none';
        document.getElementById("finalizarBtn").style.display = 'none';
    }

    window.finalizarCompra = async function() {
        if (cart.length === 0) return alert("Seu carrinho est√° vazio!");
        const user = auth.currentUser;
        if (!user) return alert("Voc√™ precisa estar logado para salvar seu hist√≥rico.");

        const finalizarBtn = document.getElementById('finalizarBtn');
        finalizarBtn.disabled = true;
        finalizarBtn.innerText = "Salvando...";

        try {
            const compra = { userId: user.uid, data: serverTimestamp(), itens: cart, total: cart.reduce((acc, p) => acc + p.total, 0) };
            await addDoc(collection(db, "compras", user.uid, "historico"), compra);
            alert("Compra salva com sucesso no seu hist√≥rico!");
            limparCarrinhoUI();
        } catch (e) {
            console.error("Erro ao salvar a compra: ", e);
            alert("Ocorreu um erro ao salvar sua compra.");
        } finally {
            finalizarBtn.disabled = false;
            finalizarBtn.innerText = "üõí Finalizar Compra";
        }
    };

    window.adicionarAoCarrinho = function() {
      const nome = document.getElementById("produto-nome").value;
      const preco = parseFloat(document.getElementById("preco-unitario").value.replace(",", ".")) || 0;
      const quantidade = parseInt(document.getElementById("quantidade").value) || 1;
      if (!nome || preco <= 0 || quantidade <= 0) return alert("Preencha corretamente nome, pre√ßo e quantidade.");

      cart.push({ nome, preco, quantidade, total: preco * quantidade });
      document.getElementById("cartCount").innerText = cart.length;
      document.getElementById("produto-info").style.display = "none";
      document.getElementById("totalBar").innerText = `Total: R$ ${cart.reduce((acc, p) => acc + p.total, 0).toFixed(2).replace(".", ",")}`;
      document.getElementById("totalBar").style.display = "block";
      document.getElementById("codigoBarra").value = "";
      document.getElementById("finalizarBtn").style.display = "block";
    };
    
    window.removerItem = function(index) {
      cart.splice(index, 1);
      document.getElementById("cartCount").innerText = cart.length;
      window.verCarrinho();
      
      if (cart.length > 0) {
          document.getElementById("totalBar").innerText = `Total: R$ ${cart.reduce((acc, p) => acc + p.total, 0).toFixed(2).replace(".", ",")}`;
      } else {
          limparCarrinhoUI();
      }
    };

    window.verCarrinho = function() {
      const container = document.getElementById("carrinhoDetalhado");
      if (cart.length === 0) { container.style.display = "none"; return; }
      let html = "<h3>Itens no Carrinho:</h3>";
      cart.forEach((item, i) => {
        html += `<div class='cart-item'><span>${item.nome} - R$ ${item.preco.toFixed(2).replace(".", ",")} x ${item.quantidade} = <strong>R$ ${item.total.toFixed(2).replace(".", ",")}</strong></span><button onclick='removerItem(${i})'>üóë</button></div>`;
      });
      container.innerHTML = html;
      container.style.display = "block";
    };

    window.iniciarCadastroManual = function() {
      document.getElementById("produto-info").style.display = "block";
      document.getElementById("produto-imagem").src = "";
      document.getElementById("produto-imagem").style.display = "none";
      document.getElementById("produto-nome").value = "";
      document.getElementById("preco-unitario").value = "";
      document.getElementById("quantidade").value = "1";
      document.getElementById("quantidade-display").innerText = "1";
      document.getElementById("produto-nome").focus();
    };

    window.cadastrarProdutoManual = window.iniciarCadastroManual;

    window.buscarProduto = function() {
      const code = document.getElementById("codigoBarra").value.trim();
      if (!code) return alert("Digite um c√≥digo de barras v√°lido.");
      
      fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`)
        .then(res => res.json())
        .then(data => {
          if (data.status === 1 && data.product) {
            const produto = data.product;
            document.getElementById("produto-imagem").style.display = "block";
            document.getElementById("produto-nome").value = produto.product_name || "";
            document.getElementById("produto-imagem").src = produto.image_url || "";
            document.getElementById("preco-unitario").focus();
            document.getElementById("produto-info").style.display = "block";
          } else { window.iniciarCadastroManual(); }
        })
        .catch(err => {
          alert("Erro de conex√£o. Por favor, cadastre o produto manualmente.");
          window.iniciarCadastroManual();
        });
    };
    
    window.escanearProduto = function() {
      const leitorHtml = document.getElementById('reader');
      leitorHtml.style.display = 'block';
      const html5QrCode = new Html5Qrcode("reader");
      const onScanSuccess = (decodedText) => {
          try { html5QrCode.stop(); } catch(err) {}
          leitorHtml.style.display = 'none';
          document.getElementById("codigoBarra").value = decodedText;
          window.buscarProduto(); 
      };
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, onScanSuccess, () => {});
    };

    window.verHistorico = async function() {
        const user = auth.currentUser;
        if (!user) return alert("Voc√™ precisa estar logado para ver seu hist√≥rico.");

        const historicoContainer = document.getElementById("historicoContainer");
        historicoContainer.innerHTML = "<h3>Buscando seu hist√≥rico...</h3>";

        try {
            const historicoRef = collection(db, "compras", user.uid, "historico");
            const q = query(historicoRef, orderBy("data", "desc"));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                historicoContainer.innerHTML = "<p>Voc√™ ainda n√£o tem nenhuma compra salva no hist√≥rico.</p>";
                return;
            }

            let htmlHistorico = "<h2>Seu Hist√≥rico de Compras</h2>";
            querySnapshot.forEach((doc) => {
                const compra = doc.data();
                const dataDaCompra = compra.data.toDate().toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
                const totalDaCompra = compra.total.toFixed(2).replace(".", ",");
                
                htmlHistorico += `<div class="historico-item">`;
                htmlHistorico += `<p><strong>Data:</strong> ${dataDaCompra}</p>`;
                htmlHistorico += `<p><strong>Total:</strong> R$ ${totalDaCompra}</p>`;
                htmlHistorico += `<button class="btn" style="width: auto; padding: 5px 10px; font-size: 14px;">Ver Detalhes</button>`;
                htmlHistorico += `</div>`;
            });
            historicoContainer.innerHTML = htmlHistorico;
        } catch (e) {
            console.error("Erro ao buscar o hist√≥rico: ", e);
            historicoContainer.innerHTML = "<p>Ocorreu um erro ao buscar seu hist√≥rico. Tente novamente.</p>";
        }
    };

    window.mudarIdioma = function() { alert("Fun√ß√£o de idioma em desenvolvimento!"); };
    window.toggleAcessibilidade = function() { document.body.classList.toggle("big-font"); };

  </script>
</body>
</html>