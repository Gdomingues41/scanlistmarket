<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanlist Market</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #fff; }
    .header { background-color: #d40000; padding: 15px; text-align: center; color: white; position: relative; display: flex; align-items: center; justify-content: space-between; }
    .header h1 { font-size: 24px; margin: 0; }
    .container { max-width: 500px; margin: 0 auto; text-align: center; padding: 16px; visibility: hidden; }
    .btn { display: block; width: 100%; background-color: #d40000; color: white; padding: 12px; margin: 8px 0; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    .input-field { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    #reader { width: 100%; height: 250px; border: 1px solid #ccc; margin: 10px 0; display: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Scanlist Market</h1>
  </div>
  <div class="container">
    <div id="mainContent">
        <input id="codigoBarra" class="input-field" placeholder="Digite ou escaneie o c√≥digo">
        <button id="btnBuscar" class="btn" onclick="buscarProduto()">üîç Buscar Produto</button>
        <button id="btnEscanear" class="btn" onclick="escanearProduto()">üì∑ Escanear Produto</button>
        <div id="reader"></div>
        <div id="produto-info" style="display:none;">
            <img id="produto-imagem" class="product-img" src="" alt="Imagem do Produto">
            <div>
                <input id="produto-nome" type="text" class="input-field" placeholder="Nome do produto">
                <input id="preco-unitario" type="number" class="input-field" placeholder="Pre√ßo unit√°rio">
            </div>
            <button id="btnAddCarrinho" class="btn" onclick="adicionarAoCarrinho()">‚ûï Adicionar ao Carrinho</button>
        </div>
    </div>
  </div>

  <script type="module">
    const scannerAtivo = false;
    let html5QrCodeInstance = null;

    const startScanner = async () => {
        const leitorHtml = document.getElementById('reader');
        leitorHtml.style.display = 'block';

        if (scannerAtivo) {
            stopScanner();
            return;
        }

        html5QrCodeInstance = new Html5Qrcode("reader");

        const config = { fps: 10, qrbox: { width: 250, height: 150 } };
        const cameraConfig = { facingMode: { ideal: "environment" } };

        const onScanSuccess = (decodedText, decodedResult) => {
            try { html5QrCodeInstance.stop(); } catch(err) {}
            leitorHtml.style.display = 'none';
            document.getElementById("codigoBarra").value = decodedText;
            buscarProduto();
        };

        const onScanFailure = (error) => {
            console.log("Falha ao escanear: ", error);
        };

        try {
            await html5QrCodeInstance.start(cameraConfig, config, onScanSuccess, onScanFailure);
        } catch (err) {
            console.error("Erro ao iniciar scanner:", err);
            leitorHtml.style.display = 'none';
            alert("N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.");
        }
    };

    const stopScanner = () => {
        try {
            if (html5QrCodeInstance && scannerAtivo) {
                html5QrCodeInstance.stop().then(() => {
                    const leitorHtml = document.getElementById('reader');
                    leitorHtml.style.display = 'none';
                }).catch(err => {
                    const leitorHtml = document.getElementById('reader');
                    leitorHtml.style.display = 'none';
                    console.warn("Erro ao parar scanner:", err);
                });
            }
        } catch (e) {
            console.warn("Erro ao parar scanner:", e);
        }
    };

    const buscarProduto = () => {
        const codigo = document.getElementById("codigoBarra").value.trim();
        if (!codigo) return alert("Digite um c√≥digo de barras v√°lido.");

        fetch(`https://world.openfoodfacts.org/api/v0/product/${codigo}.json`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 1 && data.product) {
                    const produto = data.product;
                    document.getElementById("produto-nome").value = produto.product_name || "Produto sem nome";
                    document.getElementById("produto-imagem").src = produto.image_url || "";
                } else {
                    alert("Produto n√£o encontrado.");
                }
            })
            .catch(() => {
                alert("Erro ao buscar produto.");
            });
    };

    const adicionarAoCarrinho = () => {
        const nome = document.getElementById("produto-nome").value;
        const preco = parseFloat(document.getElementById("preco-unitario").value);
        if (!nome || preco <= 0) return alert("Preencha nome e pre√ßo.");
        alert(`Produto ${nome} adicionado ao carrinho.`);
    };

    window.escanearProduto = startScanner;

  </script>
</body>
</html>
