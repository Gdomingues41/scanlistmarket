<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanlist Market</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #fff; }
    .header { background-color: #d40000; padding: 15px; text-align: center; color: white; position: relative; display: flex; align-items: center; justify-content: space-between; }
    .header h1 { font-size: 24px; margin: 0; }
    .container { max-width: 500px; margin: 0 auto; text-align: center; padding: 16px; visibility: hidden; }
    .btn { display: block; width: 100%; background-color: #d40000; color: white; padding: 12px; margin: 8px 0; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    .input-field { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    #reader { width: 100%; height: 250px; border: 1px solid #ccc; margin: 10px 0; display: none; }
    .product-img { max-width: 100%; height: auto; margin: 10px 0; }
    .error-message { color: #d40000; margin: 10px 0; font-size: 14px; }
    .loading { color: #666; margin: 10px 0; font-size: 14px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Scanlist Market</h1>
  </div>
  <div class="container">
    <div id="mainContent">
        <input id="codigoBarra" class="input-field" placeholder="Digite ou escaneie o c√≥digo">
        <button id="btnBuscar" class="btn" onclick="buscarProduto()">üîç Buscar Produto</button>
        <button id="btnEscanear" class="btn" onclick="escanearProduto()">üì∑ Escanear Produto</button>
        <div id="reader"></div>
        <div id="error-message" class="error-message" style="display:none;"></div>
        <div id="loading-message" class="loading" style="display:none;">Carregando...</div>
        <div id="produto-info" style="display:none;">
            <img id="produto-imagem" class="product-img" src="" alt="Imagem do Produto">
            <div>
                <input id="produto-nome" type="text" class="input-field" placeholder="Nome do produto">
                <input id="preco-unitario" type="number" class="input-field" placeholder="Pre√ßo unit√°rio">
            </div>
            <button id="btnAddCarrinho" class="btn" onclick="adicionarAoCarrinho()">‚ûï Adicionar ao Carrinho</button>
        </div>
    </div>
  </div>

  <script type="module">
    let scannerAtivo = false;
    let html5QrCodeInstance = null;

    // Fun√ß√£o para mostrar mensagens de erro
    const mostrarErro = (mensagem) => {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = mensagem;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    };

    // Fun√ß√£o para mostrar/esconder loading
    const mostrarLoading = (mostrar) => {
        const loadingDiv = document.getElementById('loading-message');
        loadingDiv.style.display = mostrar ? 'block' : 'none';
    };

    // Fun√ß√£o para verificar se o dispositivo suporta getUserMedia
    const verificarSuporteCamera = () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            mostrarErro('Seu dispositivo n√£o suporta acesso √† c√¢mera.');
            return false;
        }
        return true;
    };

    // Fun√ß√£o para solicitar permiss√µes de c√¢mera explicitamente
    const solicitarPermissaoCamera = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: { ideal: "environment" },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            });
            // Parar o stream imediatamente ap√≥s verificar as permiss√µes
            stream.getTracks().forEach(track => track.stop());
            return true;
        } catch (error) {
            console.error('Erro ao solicitar permiss√£o da c√¢mera:', error);
            if (error.name === 'NotAllowedError') {
                mostrarErro('Permiss√£o de c√¢mera negada. Por favor, permita o acesso √† c√¢mera nas configura√ß√µes do seu navegador.');
            } else if (error.name === 'NotFoundError') {
                mostrarErro('Nenhuma c√¢mera encontrada no dispositivo.');
            } else {
                mostrarErro('Erro ao acessar a c√¢mera: ' + error.message);
            }
            return false;
        }
    };

    const startScanner = async () => {
        // Verificar suporte antes de tentar iniciar
        if (!verificarSuporteCamera()) {
            return;
        }

        const leitorHtml = document.getElementById('reader');
        
        if (scannerAtivo) {
            stopScanner();
            return;
        }

        mostrarLoading(true);

        // Solicitar permiss√µes explicitamente primeiro
        const permissaoOk = await solicitarPermissaoCamera();
        if (!permissaoOk) {
            mostrarLoading(false);
            return;
        }

        leitorHtml.style.display = 'block';

        try {
            html5QrCodeInstance = new Html5Qrcode("reader");

            // Configura√ß√µes otimizadas para iOS
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 150 },
                aspectRatio: 1.777778, // 16:9
                disableFlip: false,
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                }
            };

            // Configura√ß√£o da c√¢mera otimizada para iOS
            const cameraConfig = { 
                facingMode: { ideal: "environment" },
                width: { ideal: 1280, min: 640 },
                height: { ideal: 720, min: 480 },
                frameRate: { ideal: 30, min: 10 }
            };

            const onScanSuccess = (decodedText, decodedResult) => {
                console.log('C√≥digo escaneado:', decodedText);
                stopScanner();
                document.getElementById("codigoBarra").value = decodedText;
                buscarProduto();
            };

            const onScanFailure = (error) => {
                // N√£o logar erros de scan failure para evitar spam no console
                // console.log("Falha ao escanear: ", error);
            };

            await html5QrCodeInstance.start(cameraConfig, config, onScanSuccess, onScanFailure);
            scannerAtivo = true;
            mostrarLoading(false);

        } catch (err) {
            console.error("Erro ao iniciar scanner:", err);
            mostrarLoading(false);
            leitorHtml.style.display = 'none';
            
            if (err.toString().includes('NotAllowedError')) {
                mostrarErro("Permiss√£o de c√¢mera negada. Verifique as configura√ß√µes do seu navegador.");
            } else if (err.toString().includes('NotFoundError')) {
                mostrarErro("C√¢mera n√£o encontrada. Verifique se seu dispositivo possui uma c√¢mera.");
            } else if (err.toString().includes('NotReadableError')) {
                mostrarErro("C√¢mera est√° sendo usada por outro aplicativo. Feche outros apps que possam estar usando a c√¢mera.");
            } else {
                mostrarErro("Erro ao acessar a c√¢mera. Tente novamente ou use a entrada manual.");
            }
        }
    };

    const stopScanner = () => {
        try {
            if (html5QrCodeInstance && scannerAtivo) {
                html5QrCodeInstance.stop().then(() => {
                    scannerAtivo = false;
                    const leitorHtml = document.getElementById('reader');
                    leitorHtml.style.display = 'none';
                    console.log('Scanner parado com sucesso');
                }).catch(err => {
                    scannerAtivo = false;
                    const leitorHtml = document.getElementById('reader');
                    leitorHtml.style.display = 'none';
                    console.warn("Erro ao parar scanner:", err);
                });
            }
        } catch (e) {
            scannerAtivo = false;
            console.warn("Erro ao parar scanner:", e);
        }
    };

    const buscarProduto = () => {
        const codigo = document.getElementById("codigoBarra").value.trim();
        if (!codigo) {
            mostrarErro("Digite um c√≥digo de barras v√°lido.");
            return;
        }

        mostrarLoading(true);
        document.getElementById("produto-info").style.display = 'none';

        fetch(`https://world.openfoodfacts.org/api/v0/product/${codigo}.json`)
            .then(res => {
                if (!res.ok) {
                    throw new Error('Erro na resposta da API');
                }
                return res.json();
            })
            .then(data => {
                mostrarLoading(false);
                if (data.status === 1 && data.product) {
                    const produto = data.product;
                    document.getElementById("produto-nome").value = produto.product_name || "Produto sem nome";
                    const imagemElement = document.getElementById("produto-imagem");
                    if (produto.image_url) {
                        imagemElement.src = produto.image_url;
                        imagemElement.style.display = 'block';
                    } else {
                        imagemElement.style.display = 'none';
                    }
                    document.getElementById("produto-info").style.display = 'block';
                } else {
                    mostrarErro("Produto n√£o encontrado na base de dados.");
                }
            })
            .catch(error => {
                mostrarLoading(false);
                console.error('Erro ao buscar produto:', error);
                mostrarErro("Erro ao buscar produto. Verifique sua conex√£o com a internet.");
            });
    };

    const adicionarAoCarrinho = () => {
        const nome = document.getElementById("produto-nome").value.trim();
        const preco = parseFloat(document.getElementById("preco-unitario").value);
        
        if (!nome) {
            mostrarErro("Preencha o nome do produto.");
            return;
        }
        
        if (!preco || preco <= 0) {
            mostrarErro("Preencha um pre√ßo v√°lido.");
            return;
        }
        
        alert(`Produto "${nome}" adicionado ao carrinho por R$ ${preco.toFixed(2)}.`);
        
        // Limpar campos ap√≥s adicionar
        document.getElementById("codigoBarra").value = '';
        document.getElementById("produto-nome").value = '';
        document.getElementById("preco-unitario").value = '';
        document.getElementById("produto-info").style.display = 'none';
    };

    // Tornar as fun√ß√µes globais
    window.escanearProduto = startScanner;
    window.buscarProduto = buscarProduto;
    window.adicionarAoCarrinho = adicionarAoCarrinho;

    // Mostrar o container quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.container').style.visibility = 'visible';
    });

    // Limpar recursos quando a p√°gina for fechada
    window.addEventListener('beforeunload', () => {
        stopScanner();
    });

  </script>
</body>
</html>

