<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanlist Market - Debug Android</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #fff; }
    .header { background-color: #d40000; padding: 15px; text-align: center; color: white; position: relative; display: flex; align-items: center; justify-content: space-between; }
    .header h1 { font-size: 24px; margin: 0; flex: 1; }
    .cart-icon { position: relative; cursor: pointer; font-size: 24px; }
    .cart-count { position: absolute; top: -8px; right: -8px; background-color: #fff; color: #d40000; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
    .container { max-width: 500px; margin: 0 auto; text-align: center; padding: 16px; visibility: hidden; }
    .btn { display: block; width: 100%; background-color: #d40000; color: white; padding: 12px; margin: 8px 0; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    .btn:hover { background-color: #b30000; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; }
    .input-field { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    #reader { width: 100%; height: 250px; border: 1px solid #ccc; margin: 10px 0; display: none; }
    .product-img { max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px; }
    .error-message { color: #d40000; margin: 10px 0; font-size: 14px; }
    .loading { color: #666; margin: 10px 0; font-size: 14px; }
    .debug-info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 12px; text-align: left; }
    .product-details { background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .quantity-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; }
    .quantity-btn { width: 40px; height: 40px; border: none; border-radius: 50%; background-color: #d40000; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .quantity-btn:hover { background-color: #b30000; }
    .quantity-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    .quantity-display { font-size: 18px; font-weight: bold; min-width: 30px; }
    .price-total { font-size: 16px; font-weight: bold; color: #d40000; margin: 10px 0; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80%; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #000; }
    .cart-item { background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 8px; }
    .cart-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .cart-item-name { font-weight: bold; flex: 1; text-align: left; }
    .remove-item { background: #ff4444; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; }
    .cart-item-details { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
    .cart-total { background: #d40000; color: white; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 18px; font-weight: bold; }
    .empty-cart { text-align: center; color: #666; margin: 40px 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Scanlist Market</h1>
    <div class="cart-icon" onclick="abrirCarrinho()">
      üõí
      <span class="cart-count" id="cart-count" style="display: none;">0</span>
    </div>
  </div>
  
  <div class="container">
    <div id="debug-info" class="debug-info">
      <strong>Informa√ß√µes de Debug:</strong><br>
      <span id="debug-text">Carregando diagn√≥sticos...</span>
    </div>
    
    <div id="mainContent">
        <input id="codigoBarra" class="input-field" placeholder="Digite ou escaneie o c√≥digo">
        <button id="btnBuscar" class="btn" onclick="buscarProduto()">üîç Buscar Produto</button>
        <button id="btnEscanear" class="btn" onclick="escanearProduto()">üì∑ Escanear Produto</button>
        <button id="btnDiagnostico" class="btn" onclick="executarDiagnostico()" style="background-color: #007bff;">üîß Executar Diagn√≥stico</button>
        <div id="reader"></div>
        <div id="error-message" class="error-message" style="display:none;"></div>
        <div id="loading-message" class="loading" style="display:none;">Carregando...</div>
        
        <div id="produto-info" class="product-details" style="display:none;">
            <img id="produto-imagem" class="product-img" src="" alt="Imagem do Produto">
            <div>
                <input id="produto-nome" type="text" class="input-field" placeholder="Nome do produto">
                <input id="preco-unitario" type="number" class="input-field" placeholder="Pre√ßo unit√°rio (R$)" step="0.01" min="0">
            </div>
            
            <div class="quantity-controls">
                <button class="quantity-btn" onclick="alterarQuantidade(-1)">-</button>
                <span class="quantity-display" id="quantidade">1</span>
                <button class="quantity-btn" onclick="alterarQuantidade(1)">+</button>
            </div>
            
            <div class="price-total" id="total-produto">Total: R$ 0,00</div>
            
            <button id="btnAddCarrinho" class="btn" onclick="adicionarAoCarrinho()">‚ûï Adicionar ao Carrinho</button>
        </div>
    </div>
  </div>

  <!-- Modal do Carrinho -->
  <div id="modalCarrinho" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Carrinho de Compras</h2>
        <span class="close" onclick="fecharCarrinho()">&times;</span>
      </div>
      <div id="lista-carrinho"></div>
      <div id="total-carrinho" class="cart-total" style="display:none;">
        Total Geral: R$ 0,00
      </div>
      <button class="btn" onclick="limparCarrinho()" style="background-color: #ff4444; margin-top: 10px;">
        üóëÔ∏è Limpar Carrinho
      </button>
    </div>
  </div>

  <script type="module">
    // Polyfill para globalThis (problema comum em Android WebView)
    if (typeof globalThis === 'undefined') {
        window.globalThis = window;
    }

    let scannerAtivo = false;
    let html5QrCodeInstance = null;
    let carrinho = [];
    let quantidadeAtual = 1;

    // Fun√ß√£o de diagn√≥stico
    const executarDiagnostico = async () => {
        const debugText = document.getElementById('debug-text');
        let diagnosticos = [];

        // 1. Verificar protocolo
        diagnosticos.push(`Protocolo: ${window.location.protocol}`);
        
        // 2. Verificar User Agent
        diagnosticos.push(`User Agent: ${navigator.userAgent}`);
        
        // 3. Verificar se est√° em WebView
        const isWebView = /wv|WebView/i.test(navigator.userAgent);
        diagnosticos.push(`√â WebView: ${isWebView ? 'Sim' : 'N√£o'}`);
        
        // 4. Verificar suporte a mediaDevices
        const hasMediaDevices = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        diagnosticos.push(`Suporte mediaDevices: ${hasMediaDevices ? 'Sim' : 'N√£o'}`);
        
        // 5. Verificar se est√° em contexto seguro
        const isSecureContext = window.isSecureContext;
        diagnosticos.push(`Contexto seguro: ${isSecureContext ? 'Sim' : 'N√£o'}`);
        
        // 6. Tentar enumerar dispositivos
        try {
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                diagnosticos.push(`C√¢meras encontradas: ${videoDevices.length}`);
            } else {
                diagnosticos.push(`C√¢meras encontradas: API n√£o dispon√≠vel`);
            }
        } catch (error) {
            diagnosticos.push(`Erro ao enumerar dispositivos: ${error.message}`);
        }
        
        // 7. Testar getUserMedia b√°sico
        try {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
                diagnosticos.push(`Teste getUserMedia: SUCESSO`);
            } else {
                diagnosticos.push(`Teste getUserMedia: API n√£o dispon√≠vel`);
            }
        } catch (error) {
            diagnosticos.push(`Teste getUserMedia: FALHOU - ${error.name}: ${error.message}`);
        }

        debugText.innerHTML = diagnosticos.join('<br>');
    };

    // Fun√ß√£o para mostrar mensagens de erro
    const mostrarErro = (mensagem) => {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = mensagem;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    };

    // Fun√ß√£o para mostrar/esconder loading
    const mostrarLoading = (mostrar) => {
        const loadingDiv = document.getElementById('loading-message');
        loadingDiv.style.display = mostrar ? 'block' : 'none';
    };

    // Fun√ß√£o para verificar se o dispositivo suporta getUserMedia
    const verificarSuporteCamera = () => {
        if (!window.isSecureContext) {
            mostrarErro('C√¢mera requer contexto seguro (HTTPS). Acesse via HTTPS ou localhost.');
            return false;
        }
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            mostrarErro('Seu dispositivo/navegador n√£o suporta acesso √† c√¢mera (getUserMedia n√£o dispon√≠vel).');
            return false;
        }
        return true;
    };

    // Fun√ß√£o para solicitar permiss√µes de c√¢mera explicitamente
    const solicitarPermissaoCamera = async () => {
        try {
            // Configura√ß√£o mais b√°sica para Android
            const constraints = {
                video: {
                    facingMode: "environment",
                    width: { ideal: 640, min: 320 },
                    height: { ideal: 480, min: 240 }
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            // Parar o stream imediatamente ap√≥s verificar as permiss√µes
            stream.getTracks().forEach(track => track.stop());
            return true;
        } catch (error) {
            console.error('Erro ao solicitar permiss√£o da c√¢mera:', error);
            
            let mensagemErro = 'Erro ao acessar a c√¢mera: ';
            
            switch (error.name) {
                case 'NotAllowedError':
                    mensagemErro += 'Permiss√£o negada. Verifique as configura√ß√µes de permiss√£o do aplicativo.';
                    break;
                case 'NotFoundError':
                    mensagemErro += 'Nenhuma c√¢mera encontrada no dispositivo.';
                    break;
                case 'NotReadableError':
                    mensagemErro += 'C√¢mera est√° sendo usada por outro aplicativo.';
                    break;
                case 'OverconstrainedError':
                    mensagemErro += 'Configura√ß√µes de c√¢mera n√£o suportadas pelo dispositivo.';
                    break;
                case 'SecurityError':
                    mensagemErro += 'Erro de seguran√ßa. Verifique se est√° usando HTTPS.';
                    break;
                default:
                    mensagemErro += `${error.name} - ${error.message}`;
            }
            
            mostrarErro(mensagemErro);
            return false;
        }
    };

    const startScanner = async () => {
        // Verificar suporte antes de tentar iniciar
        if (!verificarSuporteCamera()) {
            return;
        }

        const leitorHtml = document.getElementById('reader');
        
        if (scannerAtivo) {
            stopScanner();
            return;
        }

        mostrarLoading(true);

        // Solicitar permiss√µes explicitamente primeiro
        const permissaoOk = await solicitarPermissaoCamera();
        if (!permissaoOk) {
            mostrarLoading(false);
            return;
        }

        leitorHtml.style.display = 'block';

        try {
            html5QrCodeInstance = new Html5Qrcode("reader");

            // Configura√ß√µes mais conservadoras para Android
            const config = { 
                fps: 10, 
                qrbox: { width: 200, height: 120 },
                aspectRatio: 1.777778,
                disableFlip: false
            };

            // Configura√ß√£o da c√¢mera mais b√°sica para Android
            const cameraConfig = { 
                facingMode: "environment",
                width: { ideal: 640, min: 320 },
                height: { ideal: 480, min: 240 }
            };

            const onScanSuccess = (decodedText, decodedResult) => {
                console.log('C√≥digo escaneado:', decodedText);
                stopScanner();
                document.getElementById("codigoBarra").value = decodedText;
                buscarProduto();
            };

            const onScanFailure = (error) => {
                // N√£o logar erros de scan failure para evitar spam no console
            };

            await html5QrCodeInstance.start(cameraConfig, config, onScanSuccess, onScanFailure);
            scannerAtivo = true;
            mostrarLoading(false);

        } catch (err) {
            console.error("Erro ao iniciar scanner:", err);
            mostrarLoading(false);
            leitorHtml.style.display = 'none';
            
            let mensagemErro = "Erro ao iniciar scanner: ";
            
            if (err.toString().includes('NotAllowedError')) {
                mensagemErro += "Permiss√£o de c√¢mera negada.";
            } else if (err.toString().includes('NotFoundError')) {
                mensagemErro += "C√¢mera n√£o encontrada.";
            } else if (err.toString().includes('NotReadableError')) {
                mensagemErro += "C√¢mera em uso por outro app.";
            } else {
                mensagemErro += err.message || "Erro desconhecido.";
            }
            
            mostrarErro(mensagemErro + " Use o diagn√≥stico para mais informa√ß√µes.");
        }
    };

    const stopScanner = () => {
        try {
            if (html5QrCodeInstance && scannerAtivo) {
                html5QrCodeInstance.stop().then(() => {
                    scannerAtivo = false;
                    const leitorHtml = document.getElementById('reader');
                    leitorHtml.style.display = 'none';
                    console.log('Scanner parado com sucesso');
                }).catch(err => {
                    scannerAtivo = false;
                    const leitorHtml = document.getElementById('reader');
                    leitorHtml.style.display = 'none';
                    console.warn("Erro ao parar scanner:", err);
                });
            }
        } catch (e) {
            scannerAtivo = false;
            console.warn("Erro ao parar scanner:", e);
        }
    };

    const buscarProduto = () => {
        const codigo = document.getElementById("codigoBarra").value.trim();
        if (!codigo) {
            mostrarErro("Digite um c√≥digo de barras v√°lido.");
            return;
        }

        mostrarLoading(true);
        document.getElementById("produto-info").style.display = 'none';

        fetch(`https://world.openfoodfacts.org/api/v0/product/${codigo}.json`)
            .then(res => {
                if (!res.ok) {
                    throw new Error('Erro na resposta da API');
                }
                return res.json();
            })
            .then(data => {
                mostrarLoading(false);
                if (data.status === 1 && data.product) {
                    const produto = data.product;
                    document.getElementById("produto-nome").value = produto.product_name || "Produto sem nome";
                    const imagemElement = document.getElementById("produto-imagem");
                    if (produto.image_url) {
                        imagemElement.src = produto.image_url;
                        imagemElement.style.display = 'block';
                    } else {
                        imagemElement.style.display = 'none';
                    }
                    
                    // Resetar quantidade e pre√ßo
                    quantidadeAtual = 1;
                    document.getElementById("quantidade").textContent = quantidadeAtual;
                    document.getElementById("preco-unitario").value = '';
                    atualizarTotalProduto();
                    
                    document.getElementById("produto-info").style.display = 'block';
                } else {
                    mostrarErro("Produto n√£o encontrado na base de dados.");
                }
            })
            .catch(error => {
                mostrarLoading(false);
                console.error('Erro ao buscar produto:', error);
                mostrarErro("Erro ao buscar produto. Verifique sua conex√£o com a internet.");
            });
    };

    const alterarQuantidade = (delta) => {
        const novaQuantidade = quantidadeAtual + delta;
        if (novaQuantidade >= 1) {
            quantidadeAtual = novaQuantidade;
            document.getElementById("quantidade").textContent = quantidadeAtual;
            atualizarTotalProduto();
        }
    };

    const atualizarTotalProduto = () => {
        const preco = parseFloat(document.getElementById("preco-unitario").value) || 0;
        const total = preco * quantidadeAtual;
        document.getElementById("total-produto").textContent = `Total: R$ ${total.toFixed(2).replace('.', ',')}`;
    };

    const adicionarAoCarrinho = () => {
        const nome = document.getElementById("produto-nome").value.trim();
        const preco = parseFloat(document.getElementById("preco-unitario").value);
        const codigo = document.getElementById("codigoBarra").value.trim();
        const imagemSrc = document.getElementById("produto-imagem").src;
        
        if (!nome) {
            mostrarErro("Preencha o nome do produto.");
            return;
        }
        
        if (!preco || preco <= 0) {
            mostrarErro("Preencha um pre√ßo v√°lido.");
            return;
        }

        // Verificar se o produto j√° existe no carrinho
        const produtoExistente = carrinho.find(item => item.codigo === codigo);
        
        if (produtoExistente) {
            produtoExistente.quantidade += quantidadeAtual;
            produtoExistente.total = produtoExistente.preco * produtoExistente.quantidade;
        } else {
            const novoProduto = {
                codigo: codigo,
                nome: nome,
                preco: preco,
                quantidade: quantidadeAtual,
                total: preco * quantidadeAtual,
                imagem: imagemSrc
            };
            carrinho.push(novoProduto);
        }

        atualizarContadorCarrinho();
        
        // Limpar campos ap√≥s adicionar
        document.getElementById("codigoBarra").value = '';
        document.getElementById("produto-nome").value = '';
        document.getElementById("preco-unitario").value = '';
        document.getElementById("produto-info").style.display = 'none';
        quantidadeAtual = 1;
        
        // Mostrar feedback de sucesso
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = `Produto "${nome}" adicionado ao carrinho!`;
        errorDiv.style.display = 'block';
        errorDiv.style.color = '#28a745'; // Verde para sucesso
        setTimeout(() => {
            errorDiv.style.display = 'none';
            errorDiv.style.color = '#d40000'; // Voltar ao vermelho
        }, 3000);
    };

    const atualizarContadorCarrinho = () => {
        const contador = document.getElementById('cart-count');
        const totalItens = carrinho.reduce((total, item) => total + item.quantidade, 0);
        
        if (totalItens > 0) {
            contador.textContent = totalItens;
            contador.style.display = 'flex';
        } else {
            contador.style.display = 'none';
        }
    };

    const abrirCarrinho = () => {
        const modal = document.getElementById('modalCarrinho');
        const listaCarrinho = document.getElementById('lista-carrinho');
        const totalCarrinho = document.getElementById('total-carrinho');
        
        if (carrinho.length === 0) {
            listaCarrinho.innerHTML = '<div class="empty-cart">Seu carrinho est√° vazio</div>';
            totalCarrinho.style.display = 'none';
        } else {
            let html = '';
            let totalGeral = 0;
            
            carrinho.forEach((item, index) => {
                totalGeral += item.total;
                html += `
                    <div class="cart-item">
                        <div class="cart-item-header">
                            <span class="cart-item-name">${item.nome}</span>
                            <button class="remove-item" onclick="removerDoCarrinho(${index})">Remover</button>
                        </div>
                        <div class="cart-item-details">
                            <span>Pre√ßo unit√°rio: R$ ${item.preco.toFixed(2).replace('.', ',')}</span>
                            <span>Qtd: ${item.quantidade}</span>
                            <span>Total: R$ ${item.total.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                `;
            });
            
            listaCarrinho.innerHTML = html;
            totalCarrinho.innerHTML = `Total Geral: R$ ${totalGeral.toFixed(2).replace('.', ',')}`;
            totalCarrinho.style.display = 'block';
        }
        
        modal.style.display = 'block';
    };

    const fecharCarrinho = () => {
        document.getElementById('modalCarrinho').style.display = 'none';
    };

    const removerDoCarrinho = (index) => {
        carrinho.splice(index, 1);
        atualizarContadorCarrinho();
        abrirCarrinho(); // Atualizar a exibi√ß√£o
    };

    const limparCarrinho = () => {
        if (confirm('Tem certeza que deseja limpar todo o carrinho?')) {
            carrinho = [];
            atualizarContadorCarrinho();
            abrirCarrinho(); // Atualizar a exibi√ß√£o
        }
    };

    // Tornar as fun√ß√µes globais
    window.escanearProduto = startScanner;
    window.buscarProduto = buscarProduto;
    window.alterarQuantidade = alterarQuantidade;
    window.adicionarAoCarrinho = adicionarAoCarrinho;
    window.abrirCarrinho = abrirCarrinho;
    window.fecharCarrinho = fecharCarrinho;
    window.removerDoCarrinho = removerDoCarrinho;
    window.limparCarrinho = limparCarrinho;
    window.executarDiagnostico = executarDiagnostico;

    // Atualizar total do produto quando o pre√ßo mudar
    document.getElementById("preco-unitario").addEventListener('input', atualizarTotalProduto);

    // Fechar modal clicando fora dele
    window.addEventListener('click', (event) => {
        const modal = document.getElementById('modalCarrinho');
        if (event.target === modal) {
            fecharCarrinho();
        }
    });

    // Mostrar o container quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.container').style.visibility = 'visible';
        // Executar diagn√≥stico inicial
        executarDiagnostico();
    });

    // Limpar recursos quando a p√°gina for fechada
    window.addEventListener('beforeunload', () => {
        stopScanner();
    });

  </script>
</body>
</html>

